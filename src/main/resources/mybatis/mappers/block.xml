<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sboot.pro.argus.dao.BlockDAO">
	<!-- 블럭 리스트 -->
<!--	<select id="selectBlockList">-->
<!--		select * from blockinformation where login_area=#{searchArea} and YN='Y'-->
<!--		order by df_idNumber desc limit #{offset}, #{limit}-->
<!--	</select>-->
	<select id="selectBlockList">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, blockInformation.*
			from blockInformation where login_area = #{searchArea} and YN='Y'
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc, df_idNumber desc
	</select>
	
	<!-- 블럭 수 카운트 -->
	<select id="selectBlockCount" resultType="int">
		select count(*) from blockinformation where login_area=#{searchArea} and YN='Y'
	</select>
	
	<!-- 블럭 상세보기 -->
	<select id="selectBlockView" resultType="BlockVO">
		select * from blockinformation where df_idNumber = #{df_idNumber} and YN = 'Y'
	</select>
	
	<!-- 블럭 추가 폼 일련번호 체크 -->
	<select id="isExistIdNumber" resultType="int">
		select count(*) from blockinformation where substr(df_idNumber,1,5) = substr(#{df_idNumber},1,5) and substr(df_idNumber,7,2) = substr(#{df_idNumber},7,2) 
		and substr(df_idNumber,13,3) = substr(#{df_idNumber},13,3)
	</select>
	
	<!-- 블럭 추가 -->
	<insert id="insertBlock">
		insert into blockinformation(df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area)
		values (#{addBlockForm.df_idNumber}, #{addBlockForm.df_pictureName}, #{addBlockForm.df_material}, #{addBlockForm.df_size}, #{addBlockForm.df_usage},
		#{addBlockForm.df_weld}, #{addBlockForm.df_manufacture}, 
		#{addBlockForm.df_itemStatus}, #{addBlockForm.df_moveStatus}, #{addBlockForm.note}, #{searchArea})
	</insert>
	
	<!-- 블럭 수정 -->
	<insert id="insertUpdateLog">
		insert into blockinformation_updatelog(df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area, YN)
		select df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area, YN from blockinformation
		where df_num = #{df_num}
	</insert>
	
	<update id="updateBlock">
		update blockinformation
		set df_idNumber = #{df_idNumber},
		df_pictureName = #{df_pictureName},
		df_material = #{df_material},
		df_size = #{df_size},
		df_usage = #{df_usage},
		df_weld = #{df_weld},
		df_manufacture = #{df_manufacture},
		df_itemStatus = #{df_itemStatus},
		df_moveStatus = #{df_moveStatus},
		note = #{note}
		where df_num = #{df_num}
	</update>
	
	<!-- 블럭 삭제 -->
	<delete id="deleteBlock">
		insert into blockInformation_deleteLog(df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area)
		select df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area where df_idNumber = #{df_idNumber} 

		delete from blockInformation
		where df_idNumber = #{df_idNumber}	
	</delete>
	
	<!-- 블럭 대여 -->
	<update id="updateItemStatus">
		update blockInformation
		set df_itemStatus = '대여중',
		df_moveStatus = #{df_moveStatus}
		where df_idNumber = #{df_idNumber}
	</update>
	
	<insert id="insertMoveBlockList">
		insert into approval(df_idNumber, app_hnd_comment, login_area, app_hnd_name, app_hnd_create_at, app_rcv_area, app_rcv_name, app_rcv_create_at, app_isError, note)
		values(#{moveBlock.df_idNumber}, #{moveBlock.app_hnd_comment}, #{moveBlock.login_area}, #{moveBlock.app_hnd_name}, #{moveBlock.app_hnd_create_at}, #{moveBlock.app_rcv_area}, #{moveBlock.app_rcv_name}, #{moveBlock.app_rcv_create_at}, #{moveBlock.app_isError}, #{moveBlock.note})
		
<!--		insert into blockMoveList(moveList_lender, moveList_lender_rank, moveList_recipient, moveList_recipient_area, moveList_recipient_rank, moveList_rental_date, df_itemStatus, df_idNumber, login_area, login_id, note, created_at, app_num)-->
<!--		select #{moveBlock.moveList_lender}, #{moveBlock.moveList_lender_rank}, #{moveBlock.moveList_recipient}, #{moveBlock.moveList_recipient_area}, #{moveBlock.moveList_recipient_rank}, #{moveBlock.moveList_rental_date}, '대여중', #{moveBlock.df_idNumber}, #{login_area}, #{login_id}, #{moveBlock.note}, #{moveBlock.created_at}, app_num from Approval where df_idNumber = #{moveBlock.df_idNumber} and created_at = #{moveBlock.created_at}-->
	</insert>
	
	<!-- 대여한 블럭 수 카운트 -->
	<select id="selectRentalListCount" parameterType="String" resultType="int">
		select count(*) from blockMoveList
		where moveList_recipient_area = #{searchArea}
	</select>
	
	<!-- 대여한 블럭 리스트 -->	
	<select id="selectBlockRentalList" parameterType="list">
		select * from (
			select row_number() over (order by a.df_idNumber asc) as row_num, a.*, b.df_size, b.df_material, b.df_usage from blockMoveList a inner join blockInformation b on 
			a.df_idNumber = b.df_idNumber where moveList_return_date is null
			<if test="searchArea != '본사'">
			and moveList_recipient_area = #{searchArea}
			</if>
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc, df_idNumber desc
	</select>
	
	<!-- 블럭 반납 -->
	<select id="selectIdNumber" parameterType="int" resultType="String">
		select df_idNumber from blockMoveList where app_num = #{app_num}
	</select>
	
	<update id="updateReturnStatus" parameterType="String">
		update blockInformation a
		set df_itemStatus = '사용중',
		df_moveStatus = '-'
		where df_idNumber = #{df_idNumber}
	</update>
	
	<update id="updateReturnRecipient" parameterType="int">
		update blockMoveList
		set df_itemStatus = '사용중',
		moveList_return_date = now()
		where app_num = #{app_num}
	</update>
	
	<!-- 블럭 이동 기록 수 카운트 -->
	<select id="selectBlockMoveListCount" resultType="int">
		select count(*) from blockMoveList where YN = 'Y'
		<if test="searchArea != '본사'">
		and (login_area = #{searchArea} or moveList_recipient_area = #{searchArea})
		</if>
	</select>
	
	<!-- 블럭 이동 기록 -->
	<select id="selectBlockMoveList" parameterType="String">
		<choose>
			<when test="searchArea == '본사'">
			select * from (
				select row_number() over (order by moveList_rental_date asc) as row_num, blockMoveList.* from blockMoveList where YN = 'Y' 
				order by row_num desc, moveList_rental_date desc limit #{offset}, #{limit}
			) sub
			order by row_num desc
			</when>
			<otherwise>
			select * from (
				select row_number() over (order by moveList_rental_date asc) as row_num, blockMoveList.* from blockMoveList where (login_area = #{searchArea} or moveList_recipient_area = #{searchArea}) and YN = 'Y'
				order by row_num desc, moveList_rental_date desc limit #{offset}, #{limit}
			) sub
			order by row_num desc
			</otherwise>
		</choose>
	</select>
	
	<!-- 블럭 검색 및 페이징 카운트 수 -->
	<sql id="searchList">
		<where>
	        <choose>
	            <when test="searchType == 'idNumber'">
	                df_idNumber LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'material'">
	                df_material LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'usage'">
	                df_usage LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'form'">
	                df_weld LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'manufacture'">
	                df_manufacture LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'itemStatus'">
	                df_itemStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'moveStatus'">
	                df_moveStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'note'">
	                df_note LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <otherwise>
	                1 = 1
	            </otherwise>
	        </choose>
	    </where>
	</sql>
	
	<sql id="aliasSearchList">
		<where>
	        <choose>
	            <when test="searchType == 'idNumber'">
	                ${alias}.df_idNumber LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'material'">
	               ${alias}.df_material LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'usage'">
	                ${alias}.df_usage LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'form'">
	                ${alias}.df_weld LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'manufacture'">
	                ${alias}.df_manufacture LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'itemStatus'">
	                ${alias}.df_itemStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'moveStatus'">
	                ${alias}.df_moveStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'note'">
	                ${alias}.df_note LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <otherwise>
	                1 = 1
	            </otherwise>
	        </choose>
	    </where>
	</sql>
	
	<!-- 검색 목록 -->
	<select id="selectSearchList" parameterType="Map">
		<choose>
			<when test="searchArea == '본사'">
				select * from (
					select row_number() over (order by df_idNumber asc) as row_num, blockInformation.* 
					from blockInformation
					<include refid="searchList" />
					and YN = 'Y'
					order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
				) sub
				order by row_num desc, df_idNumber desc
			</when>
			<otherwise>
				select * from (
					select row_number() over (order by df_idNumber asc) as row_num, blockInformation.* 
					from blockInformation
					<include refid="searchList" />
					and login_area = #{searchArea} and YN = 'Y'
					order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
				) sub
				order by row_num desc, df_idNumber desc
			</otherwise>
		</choose>
	</select>
	
	<!-- 검색 수 카운트 1 -->
	<select id="selectListCount" resultType="int" parameterType="Map">
	    select count(*) 
	    from blockInformation
	    <include refid="searchList" />
	    and YN = 'Y'
	    <if test="token == 'blockRentalList'">
	        and df_idNumber in
	        <foreach item="id" collection="idNumber" open="(" separator="," close=")">
	            #{id}
	        </foreach>
    	</if>
    	<if test="token != 'blockRentalList' and searchArea != '본사' and token != 'blockTotalList'">
    		and login_area = #{searchArea}
    	</if>
    	<if test="token == 'blockTotalList'">
    		<if test="searchArea != '본사'">
    			and login_area not like concat('%',#{searchArea},'%')
    		</if>
    	</if>
	</select>
	
	<!-- 검색 수 카운트 2 -->
	<select id="selectMoveListCount" resultType="int" parameterType="Map">
		select count(*) from blockInformation a inner join blockMoveList b on a.df_idNumber = b.df_idNumber
		<include refid="aliasSearchList">
			<property name="alias" value="a"/>
		</include>
		and a.YN = 'Y'
		<if test="searchArea != '본사'">
		and (a.login_area = #{searchArea} or b.moveList_recipient_area = #{searchArea})
		</if>
	</select>
	
	<!-- 검색 식별번호 찾기 1 -->
	<select id="selectIdNumberSearch" parameterType="Map">
		select a.df_idNumber from blockInformation a inner join blockMoveList b on
		a.df_idNumber = b.df_idNumber
		<include refid="aliasSearchList">
			<property name="alias" value="a"/>
		</include>
		and a.YN = 'Y'
		<if test="searchArea != '본사'">
			and (a.login_area = #{searchArea} or (b.moveList_recipient_area = #{searchArea} and b.moveList_return_date is null))
		</if>
	</select>
	
	<!-- 검색 이동 기록 -->
	<select id="selectSearchMoveList" parameterType="Map">
		select * from blockMoveList
		where YN = 'Y' and df_idNumber in 
		<foreach item="id" collection="idNumber" open="(" separator="," close=")">
			#{id}
		</foreach>
		order by moveList_rental_date desc limit #{offset}, #{limit};
	</select>
	
	<!-- 검색 식별번호 찾기 2-->
	<select id="selectRentalListId" parameterType="Map">
		select df_idNumber from blockMoveList where YN = 'Y'
			<if test="searchArea != '본사'">
				and moveList_recipient_area = #{searchArea} and moveList_return_date is null
			</if>
	</select>
	
	<!-- 검색 대여 기록 -->
	<select id="selectSearchRentalList" parameterType="Map">
		select * from blockInformation
		<include refid="searchList" />
		and YN = 'Y' and df_idNumber in
		<foreach item="id" collection="idNumber" open="(" separator="," close=")">
			#{id}
		</foreach>
		order by df_idNumber desc limit #{offset}, #{limit}
	</select>
	
	<!-- 전체 블럭 보기 수 카운트 -->
	<select id="selectBlockTotalCount" parameterType="String" resultType="int">
		select count(*) from blockInformation where YN = 'Y'
		<if test="searchArea != '본사'">
			and login_area not like concat('%',#{searchArea},'%')
		</if>
	</select>
	
	<!-- 전체 블럭 리스트 -->
	<select id="selectBlockTotalList" parameterType="Map">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, blockInformation.* 
			from blockInformation where YN = 'Y'
			<if test="searchArea != '본사'">
				and login_area not like concat('%',#{searchArea},'%')
			</if>
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc, df_idNumber desc
	</select>
	
	<!-- 전체 블럭 리스트 검색 수 카운트 -->
	<select id="selectSearchTotalList" parameterType="Map">
		select * from (
			select row_number() over (order by df_idNumber desc) as row_num, blockInformation.* from blockInformation
			<include refid="searchList" />
			and YN = 'Y'
			<if test="searchArea != '본사'">
				and login_area not like concat('%',#{searchArea},'%')
			</if>
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc
	</select>
	
	<!-- 승인 대기 수 카운트 -->
	<select id="selectApprovalCount" parameterType="String" resultType="int">
		select count(*) from approval
		<if test="searchArea != '본사'">
			where login_area = #{searchArea}
		</if>
	</select>
	
	<!-- 승인 대기 리스트 -->
	<select id="selectApprovalList" parameterType="Map">
		select * from (
			select row_number() over (order by app_hnd_create_at asc) as row_num, approval.* from approval
			<if test="searchArea != '본사'">
				where login_area = #{searchArea} or app_rcv_area = #{searchArea}
			</if>
			order by row_num desc, app_hnd_create_at desc limit #{offset}, #{limit}
		) sub
		order by row_num desc
	</select>
	
	<!-- 이동 보고서 상세보기 -->	
	<select id="selectBlockApprovalView_df_idNumber" parameterType="int" resultType="String">
		select df_idNumber from Approval where app_num = #{app_num};
	</select>
	
	<select id="selectBlockApprovalView" parameterType="int" resultType="BlockVO">
		select * from Approval where app_num = #{app_num}
	</select>
	
	<select id="ApprovalDivision" parameterType="int">
		select * from Approval where app_num = #{app_num}
	</select>
	
	<!-- 이동 승인 -->
	<update id="updateApproval" parameterType="Map">
		update Approval
		<if test="searchArea != '본사'">
			set app_rcv_status = 'Y'
		</if>
		<if test="searchArea == '본사'">
			set app_head_status = 'Y'
		</if>
		where app_num = #{app_num}
	</update>
	
	<select id="tnfCheck" parameterType="int" resultType="int">
		select count(*) from Approval where app_num = #{app_num} and app_rcv_status = 'Y' and app_head_status = 'Y'
	</select>
	
	<insert id="finalApproval" parameterType="Map">
		insert into blockMoveList(moveList_lender, moveList_recipient, moveList_recipient_area, moveList_rental_date, df_itemStatus, df_idNumber, login_area, YN)
		select app_hnd_name, app_rcv_name, app_rcv_area, app_hnd_create_at, '대여중', df_idNumber, login_area, 'Y' from Approval where app_num = #{app_num};
		
		update blockInformation
		set df_itemStatus = '대여중',
		set df_moveStatus = #{searchArea}
		where df_idNumber = #{df_idNumber}
	</insert>
	
	<!-- 이동 거절 -->
	<update id="updateRejection" parameterType="Map">
		update Approval
		<if test="searchArea != '본사'">
			set app_branch_status = '거절',
			app_branch_comment = #{app_comment}
		</if>
				<if test="searchArea == '본사'">
			set app_head_status = '거절',
			app_head_comment = #{app_comment}
		</if>
		where app_num = #{app_num}
	</update>
	
	<update id="finalRejection" parameterType="int">
		update blockMoveList
		set moveList_return_date = now()
		where app_num = #{app_num};
		
		update blockInformation
		set df_itemStatus = '사용중',
		df_moveStatus = '-'
		where df_idNumber = (select df_idNumber from blockMoveList where app_num = #{app_num})
	</update>
	
	<!-- 블럭 스펙 추가 -->
	<insert id="insertBlockSpec" parameterType="Map">
		insert into blockSpec_image(df_idNumber, file_name, file_path)
		values (#{df_idNumber}, #{img.file_name}, #{img.file_path})
	</insert>
	
	<!-- 블럭 스펙 보기 -->
	<select id="selectBlockSpecView" parameterType="String">
		select * from blockSpec_Image where df_idNumber = #{df_idNumber}
	</select>
	
	<!-- 블럭 스펙 삭제 -->
	<select id="deleteBlockSpec" parameterType="String">
		delete from blockSpec_Image where df_idNumber = #{df_idNumber}
	</select>
	
	<!-- 블럭 점검 게시판 수 카운트 -->
	<select id="inspectionBoardCount" parameterType="String">
		select count(*) from blockInspectionBoard
		<if test="searchArea != '본사'">
			where login_area = #{searchArea}
		</if>
	</select>
	
	<!-- 블럭 점검 리스트 -->
	<select id="selectInspectionBoard" parameterType="String">
		select * from (
			select row_number() over (order by bib_date asc) as row_num, blockInspectionBoard.* from blockInspectionBoard 
			<if test="searchArea != '본사'">
				where login_area = #{searchArea}
			</if>
			order by row_num desc limit #{offset}, #{limit}
		) sub order by row_num desc
	</select>
	
	<!-- 블럭 점검 폼 -->
	<select id="inspectionList" parameterType="String">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, df_idNumber from blockInformation where login_area = #{searchArea}
		) sub
	</select>
</mapper>