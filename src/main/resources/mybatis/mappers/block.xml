<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sboot.pro.argus.dao.BlockDAO">
	<!-- 블럭 리스트 -->
<!--	<select id="selectBlockList">-->
<!--		select * from blockinformation where login_area=#{searchArea} and YN='Y'-->
<!--		order by df_idNumber desc limit #{offset}, #{limit}-->
<!--	</select>-->
	<select id="selectBlockList">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, blockInformation.*
			from blockInformation where login_area = #{searchArea} and YN='Y'
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc, df_idNumber desc
	</select>
	
	<!-- 블럭 수 카운트 -->
	<select id="selectBlockCount" resultType="int">
		select count(*) from blockinformation where login_area=#{searchArea} and YN='Y'
	</select>
	
	<!-- 블럭 상세보기 -->
	<select id="selectBlockView" resultType="BlockVO">
		select * from blockinformation where df_num = #{df_num} and YN = 'Y'
	</select>
	
	<!-- 블럭 추가 폼 일련번호 체크 -->
	<select id="isExistIdNumber" resultType="int">
		select count(*) from blockinformation where substr(df_idNumber,1,5) = substr(#{df_idNumber},1,5) and substr(df_idNumber,7,2) = substr(#{df_idNumber},7,2) 
		and substr(df_idNumber,13,3) = substr(#{df_idNumber},13,3)
	</select>
	
	<!-- 블럭 추가 -->
	<insert id="insertBlock">
		insert into blockinformation(df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area)
		values (#{addBlockForm.df_idNumber}, #{addBlockForm.df_pictureName}, #{addBlockForm.df_material}, #{addBlockForm.df_size}, #{addBlockForm.df_usage},
		#{addBlockForm.df_weld}, #{addBlockForm.df_manufacture}, 
		#{addBlockForm.df_itemStatus}, #{addBlockForm.df_moveStatus}, #{addBlockForm.note}, #{searchArea})
	</insert>
	
	<!-- 블럭 수정 -->
	<insert id="insertUpdateLog">
		insert into blockinformation_updatelog(df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area, YN)
		select df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area, YN from blockinformation
		where df_num = #{df_num}
	</insert>
	
	<update id="updateBlock">
		update blockinformation
		set df_idNumber = #{df_idNumber},
		df_pictureName = #{df_pictureName},
		df_material = #{df_material},
		df_size = #{df_size},
		df_usage = #{df_usage},
		df_weld = #{df_weld},
		df_manufacture = #{df_manufacture},
		df_itemStatus = #{df_itemStatus},
		df_moveStatus = #{df_moveStatus},
		note = #{note}
		where df_num = #{df_num}
	</update>
	
	<!-- 블럭 삭제 -->
	<delete id="deleteBlock">
		insert into blockInformation_deleteLog(df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area)
		select df_idNumber, df_pictureName, df_material, df_size, df_usage, df_weld, df_manufacture, df_itemStatus, df_moveStatus, note, login_area from blockInformation where df_idNumber = #{df_idNumber};
		
		delete from blockInformation
		where df_idNumber = #{df_idNumber}	
	</delete>
	
	<!-- 블럭 대여 -->
	<update id="updateItemStatus">
		update blockInformation
		set df_itemStatus = '대여중',
		df_moveStatus = #{df_moveStatus}
		where df_idNumber = #{df_idNumber}
	</update>
	
	<insert id="insertMoveBlockList">
		insert into approval(df_idNumber, app_hnd_comment, login_area, app_hnd_area, app_hnd_name, app_hnd_create_at, app_hnd_transMethod, app_rcv_area, app_rcv_name, app_rcv_create_at, app_isError, note, app_type)
		values(#{moveBlock.df_idNumber}, #{moveBlock.app_hnd_comment}, #{moveBlock.login_area}, #{moveBlock.app_hnd_area}, #{moveBlock.app_hnd_name}, #{moveBlock.app_hnd_create_at}, #{moveBlock.app_hnd_transMethod}, #{moveBlock.app_rcv_area}, #{moveBlock.app_rcv_name}, #{moveBlock.app_rcv_create_at}, #{moveBlock.app_isError}, #{moveBlock.note}, #{moveBlock.app_type});
		
		update blockInformation
		set df_itemStatus = '승인대기중'
		where df_idNumber = #{moveBlock.df_idNumber}
		
<!--		insert into blockMoveList(moveList_lender, moveList_lender_rank, moveList_recipient, moveList_recipient_area, moveList_recipient_rank, moveList_rental_date, df_itemStatus, df_idNumber, login_area, login_id, note, created_at, app_num)-->
<!--		select #{moveBlock.moveList_lender}, #{moveBlock.moveList_lender_rank}, #{moveBlock.moveList_recipient}, #{moveBlock.moveList_recipient_area}, #{moveBlock.moveList_recipient_rank}, #{moveBlock.moveList_rental_date}, '대여중', #{moveBlock.df_idNumber}, #{login_area}, #{login_id}, #{moveBlock.note}, #{moveBlock.created_at}, app_num from Approval where df_idNumber = #{moveBlock.df_idNumber} and created_at = #{moveBlock.created_at}-->
	</insert>
	
	<!-- 블럭 외부 반출 -->
	<insert id="insertExpertBlock">
		insert into expertApproval(df_idNumber, app_hnd_comment, app_period, login_area, app_hnd_area, app_hnd_name, app_hnd_create_at, app_hnd_transMethod, app_rcv_area, app_rcv_name, app_rcv_create_at, app_isError, note, app_type)
		values(#{df_idNumber}, #{app_hnd_comment}, #{app_period}, #{login_area}, #{app_hnd_area}, #{app_hnd_name}, #{app_hnd_create_at}, #{app_hnd_transMethod}, #{app_rcv_area}, #{app_rcv_name}, #{app_rcv_create_at}, #{app_isError}, #{note}, #{app_type});
		
		update blockInformation
		set df_itemStatus = '승인대기중'
		where df_idNumber = #{df_idNumber}
	</insert>
	
	<!-- 대여한 블럭 수 카운트 -->
	<select id="selectRentalListCount" parameterType="String" resultType="int">
		select count(*) from blockMoveList
		where moveList_recipient_area = #{searchArea}
	</select>
	
	<!-- 대여한 블럭 리스트 -->	
	<select id="selectBlockRentalList" parameterType="list">
		select * from (
			select row_number() over (order by a.df_idNumber asc) as row_num, a.*, b.df_size, b.df_material, b.df_usage from blockMoveList a inner join blockInformation b on 
			a.df_idNumber = b.df_idNumber where moveList_return_date is null
			<if test="searchArea != '본사'">
			and moveList_recipient_area = #{searchArea}
			</if>
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc, df_idNumber desc
	</select>
	
	<!-- 블럭 반출 반납요청-->
	<update id="updateReturnRequest" parameterType="int">
		update expertApproval
		set returnRequest = 'Y'
		where app_num = #{app_num}
	</update>
	
	<insert id="insertReturnRequestFormData" parameterType="int">
		insert into expertApproval(df_idNumber, app_hnd_comment, app_period, login_area, app_hnd_area, app_hnd_name, app_hnd_create_at, app_rcv_area, app_rcv_name, note, app_type, expSign_num, returnRequest, request_reject_num)
		select df_idNumber, '반납', app_period, login_area, app_rcv_area, app_rcv_name, now(), login_area, app_hnd_name, note, 'return', expSign_num, 'Y', app_num from expertApproval where app_num = #{app_num}
	</insert>
	
	<!-- 블럭 반납 -->
	<update id="updateReturnWaiting">
		update blockMoveList
		set df_itemStatus = '승인대기중'
		where app_num = #{app_num}
	</update>
	
	<insert id="finalApprovalReturn" parameterType="Map">
		update blockInformation
		set df_itemStatus = '이상없음',
		df_moveStatus = #{app_rcv_area}
		where df_idNumber = #{df_idNumber}
	</insert>
	
	<select id="selectIdNumber" parameterType="int" resultType="String">
		select df_idNumber from Approval where app_num = #{app_num}
	</select>
	
	<update id="updateReturnStatus" parameterType="String">
		update blockInformation
		set df_itemStatus = '이상없음',
		df_moveStatus = '-'
		where df_idNumber = #{df_idNumber}
	</update>
	
	<update id="updateReturnRecipient" parameterType="String">
		update blockMoveList
		set df_itemStatus = '이상없음',
		moveList_return_date = now()
		where df_idNumber = #{df_idNumber} and moveList_return_date is null
	</update>
	
	<!-- 블럭 이동 기록 수 카운트 -->
	<select id="selectBlockMoveListCount" resultType="int">
		select count(*) from blockMoveList where YN = 'Y'
		<if test="searchArea != '본사'">
		and (login_area = #{searchArea} or moveList_recipient_area = #{searchArea})
		</if>
	</select>
	
	<!-- 블럭 이동 기록 -->
	<select id="selectBlockMoveList" parameterType="String">
		<choose>
			<when test="searchArea == '본사'">
			select * from (
				select row_number() over (order by moveList_rental_date asc) as row_num, blockMoveList.* from blockMoveList where YN = 'Y' 
				order by row_num desc, moveList_rental_date desc limit #{offset}, #{limit}
			) sub
			order by row_num desc
			</when>
			<otherwise>
			select * from (
				select row_number() over (order by moveList_rental_date asc) as row_num, blockMoveList.* from blockMoveList where (login_area = #{searchArea} or moveList_recipient_area = #{searchArea}) and YN = 'Y'
				order by row_num desc, moveList_rental_date desc limit #{offset}, #{limit}
			) sub
			order by row_num desc
			</otherwise>
		</choose>
	</select>
	
	<!-- 블럭 검색 및 페이징 카운트 수 -->
	<sql id="searchList">
		<where>
	        <choose>
	            <when test="searchType == 'idNumber'">
	                df_idNumber LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'material'">
	                df_material LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'usage'">
	                df_usage LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'manufacture'">
	                df_manufacture LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'itemStatus'">
	                df_itemStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'moveStatus'">
	                df_moveStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'note'">
	                df_note LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <otherwise>
	                1 = 1
	            </otherwise>
	        </choose>
	    </where>
	</sql>
	
	<sql id="aliasSearchList">
		<where>
	        <choose>
	            <when test="searchType == 'idNumber'">
	                ${alias}.df_idNumber LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'material'">
	               ${alias}.df_material LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'usage'">
	                ${alias}.df_usage LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'manufacture'">
	                ${alias}.df_manufacture LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'itemStatus'">
	                ${alias}.df_itemStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'moveStatus'">
	                ${alias}.df_moveStatus LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <when test="searchType == 'note'">
	                ${alias}.df_note LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
	            <otherwise>
	                1 = 1
	            </otherwise>
	        </choose>
	    </where>
	</sql>
	
	<!-- 검색 목록 -->
	<select id="selectSearchList" parameterType="Map">
		<choose>
			<when test="searchArea == '본사'">
				select * from (
					select row_number() over (order by df_idNumber asc) as row_num, blockInformation.* 
					from blockInformation
					<include refid="searchList" />
					and YN = 'Y'
					order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
				) sub
				order by row_num desc, df_idNumber desc
			</when>
			<otherwise>
				select * from (
					select row_number() over (order by df_idNumber asc) as row_num, blockInformation.* 
					from blockInformation
					<include refid="searchList" />
					and login_area = #{searchArea} and YN = 'Y'
					order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
				) sub
				order by row_num desc, df_idNumber desc
			</otherwise>
		</choose>
	</select>
	
	<!-- 검색 수 카운트 1 -->
	<select id="selectListCount" resultType="int" parameterType="Map">
	    select count(*) 
	    from blockInformation
	    <include refid="searchList" />
	    and YN = 'Y'
	    <if test="token == 'blockRentalList'">
	        and df_idNumber in
	        <foreach item="id" collection="idNumber" open="(" separator="," close=")">
	            #{id}
	        </foreach>
    	</if>
    	<if test="token != 'blockRentalList' and searchArea != '본사' and token != 'blockTotalList'">
    		and login_area = #{searchArea}
    	</if>
    	<if test="token == 'blockTotalList'">
    		<if test="searchArea != '본사'">
    			and login_area not like concat('%',#{searchArea},'%')
    		</if>
    	</if>
	</select>
	
	<!-- 검색 수 카운트 2 -->
	<select id="selectMoveListCount" resultType="int" parameterType="Map">
		select count(*) from blockInformation a inner join blockMoveList b on a.df_idNumber = b.df_idNumber
		<include refid="aliasSearchList">
			<property name="alias" value="a"/>
		</include>
		and a.YN = 'Y'
		<if test="searchArea != '본사'">
		and (a.login_area = #{searchArea} or b.moveList_recipient_area = #{searchArea})
		</if>
	</select>
	
	<!-- 검색 식별번호 찾기 1 -->
	<select id="selectIdNumberSearch" parameterType="Map">
		select a.df_idNumber from blockInformation a inner join blockMoveList b on
		a.df_idNumber = b.df_idNumber
		<include refid="aliasSearchList">
			<property name="alias" value="a"/>
		</include>
		and a.YN = 'Y'
		<if test="searchArea != '본사'">
			and (a.login_area = #{searchArea} or (b.moveList_recipient_area = #{searchArea} and b.moveList_return_date is null))
		</if>
	</select>
	
	<!-- 검색 이동 기록 -->
	<select id="selectSearchMoveList" parameterType="Map">
		select * from (
			select row_number() over (order by a.moveList_rental_date asc) as row_num, a.*, b.df_size, b.df_material, b.df_usage from blockMoveList a inner join blockInformation b on 
			a.df_idNumber = b.df_idNumber
			where a.YN = 'Y' and a.df_idNumber in 
			<foreach item="id" collection="idNumber" open="(" separator="," close=")">
				#{id}
			</foreach>
			order by row_num desc limit #{offset}, #{limit}
		) sub
		order by row_num desc;
	</select>
	
	<!-- 검색 식별번호 찾기 2-->
	<select id="selectRentalListId" parameterType="Map">
		select df_idNumber from blockMoveList where YN = 'Y'
			<if test="searchArea != '본사'">
				and moveList_recipient_area = #{searchArea} and moveList_return_date is null
			</if>
	</select>
	
	<!-- 검색 대여 기록 -->
	<select id="selectSearchRentalList" parameterType="list">
		select * from (
			select row_number() over (order by a.moveList_rental_date asc) as row_num, a.*, b.df_size, b.df_material, b.df_usage from blockMoveList a inner join blockInformation b on 
			a.df_idNumber = b.df_idNumber 
			<include refid="aliasSearchList">
				<property name="alias" value="b"/>
			</include>
			and a.YN = 'Y' and moveList_return_date is null 
			and a.df_idNumber in
			<foreach item="id" collection="idNumber" open="(" separator="," close=")">
				#{id}
			</foreach>
			order by row_num desc limit #{offset}, #{limit}
		) sub
		order by row_num desc
	</select>
	
	<!-- 전체 블럭 보기 수 카운트 -->
	<select id="selectBlockTotalCount" parameterType="String" resultType="int">
		select count(*) from blockInformation where YN = 'Y'
		<if test="searchArea != '본사'">
			and login_area not like concat('%',#{searchArea},'%')
		</if>
	</select>
	
	<!-- 전체 블럭 리스트 -->
	<select id="selectBlockTotalList" parameterType="Map">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, blockInformation.* 
			from blockInformation where YN = 'Y'
			<if test="searchArea != '본사'">
				and login_area not like concat('%',#{searchArea},'%')
			</if>
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc, df_idNumber desc
	</select>
	
	<!-- 전체 블럭 리스트 검색 수 카운트 -->
	<select id="selectSearchTotalList" parameterType="Map">
		select * from (
			select row_number() over (order by df_idNumber desc) as row_num, blockInformation.* from blockInformation
			<include refid="searchList" />
			and YN = 'Y'
			<if test="searchArea != '본사'">
				and login_area not like concat('%',#{searchArea},'%')
			</if>
			order by row_num desc, df_idNumber desc limit #{offset}, #{limit}
		) sub
		order by row_num desc
	</select>
	
	<!-- 승인 대기 수 카운트 -->
	<select id="selectApprovalCount" parameterType="String" resultType="int">
		select count(*) from approval
		<if test="searchArea != '본사'">
			where login_area = #{searchArea}
		</if>
	</select>
	
	<!-- 승인 대기 리스트 -->
	<select id="selectApprovalList" parameterType="Map">
		select * from (
			select row_number() over (order by app_hnd_create_at asc) as row_num, approval.* from approval
			<if test="searchArea != '본사'">
				where login_area = #{searchArea} or app_rcv_area = #{searchArea}
			</if>
			order by row_num desc, app_hnd_create_at desc limit #{offset}, #{limit}
		) sub
		order by row_num desc
	</select>
	
	<!-- 반출 승인 대기 수 카운트 -->
	<select id="selectExpertApprovalCount" parameterType="String" resultType="int">
		select count(*) from expertApproval
		<if test="searchArea != '본사'">
			where login_area = #{searchArea}
		</if>
	</select>
	
	<!-- 반출 승인 대기 리스트 -->
	<select id="selectExpertApprovalList" parameterType="Map">
		select * from (
			select row_number() over (order by app_hnd_create_at asc) as row_num, expertApproval.* from expertApproval
			<if test="searchArea != '본사'">
				where login_area = #{searchArea} or app_rcv_area = #{searchArea}
			</if>
			order by row_num desc, app_hnd_create_at desc limit #{offset}, #{limit}
		) sub
		order by row_num desc
	</select>
	
	<!-- 이동 보고서 상세보기 -->	
	<select id="selectBlockApprovalView_df_idNumber" parameterType="int" resultType="com.sboot.pro.argus.vo.BlockVO">
		select df_idNumber, app_rcv_area from Approval where app_num = #{app_num};
	</select>
	
	<select id="selectBlockApprovalView" parameterType="int" resultType="BlockVO">
		select * from Approval where app_num = #{app_num}
	</select>
	
	<select id="ApprovalDivision" parameterType="int">
		select * from Approval where app_num = #{app_num}
	</select>
	
	<!-- 반출 이동 보고서 상세보기 -->
	<select id="selectExpertBlockApprovalView_df_idNumber" parameterType="int" resultType="com.sboot.pro.argus.vo.BlockVO">
		select df_idNumber, app_rcv_area from expertApproval where app_num = #{app_num};
	</select>
	
	<select id="selectExpSign_num" parameterType="int">
		select expSign_num from expertApproval where app_num = #{app_num}
	</select>
	
	<select id="selectExpertBlockApprovalView" parameterType="int" resultType="BlockVO">
		<if test="expSign_num == 0">
			select * from expertApproval where app_num = #{app_num}		
		</if>
		<if test="expSign_num != 0">
			select * from expertApproval a inner join expertSignList b on a.expSign_num = b.expSign_num where a.app_num = #{app_num};
		</if>
	</select>
	
	<!-- 이동 승인 -->
	<update id="updateApproval" parameterType="Map">
		update Approval
		<if test="searchArea != '본사'">
			set app_rcv_status = 'Y',
			app_isError = #{app_isError},
			app_rcv_create_at = now()
		</if>
		<if test="searchArea == '본사'">
			set app_head_status = 'Y',
			app_isError = #{app_isError}
		</if>
		where app_num = #{app_num}
	</update>
	
	<select id="tnfCheck" parameterType="int" resultType="int">
		select count(*) from Approval where app_num = #{app_num} and app_rcv_status = 'Y' and app_head_status = 'Y'
	</select>
	
	<insert id="finalApproval" parameterType="Map">
		insert into blockMoveList(moveList_lender, moveList_recipient, moveList_recipient_area, moveList_rental_date, df_itemStatus, df_idNumber, login_area, YN, app_num)
		select app_hnd_name, app_rcv_name, app_rcv_area, app_hnd_create_at, '대여중', df_idNumber, login_area, 'Y', app_num from Approval where app_num = #{app_num};
		
		update blockInformation
		set df_itemStatus = '대여중',
		df_moveStatus = #{app_rcv_area}
		where df_idNumber = #{df_idNumber}
	</insert>
	
	<!-- 반출 이동 승인 -->
	<update id="updateExpertApproval" parameterType="Map">
		update expertApproval
		<if test="searchArea != '본사'">
			set app_rcv_status = 'Y',
			app_isError = #{app_isError},
			app_rcv_create_at = now()
		</if>
		<if test="searchArea == '본사'">
			set app_head_status = 'Y',
			app_isError = #{app_isError}
		</if>
		where app_num = #{app_num}
	</update>
	
	<select id="tnfExpertCheck" parameterType="int" resultType="int">
		select count(*) from expertApproval where app_num = #{app_num} and app_rcv_status = 'Y' and app_head_status = 'Y'
	</select>
	
	<insert id="finalExpertApproval" parameterType="Map">
		insert into blockMoveList(moveList_lender, moveList_recipient, moveList_recipient_area, moveList_rental_date, df_itemStatus, df_idNumber, login_area, YN, app_num)
		select app_hnd_name, app_rcv_name, app_rcv_area, app_hnd_create_at, '대여중', df_idNumber, login_area, 'Y', app_num from expertApproval where app_num = #{app_num};
		
		update blockInformation
		set df_itemStatus = '대여중',
		df_moveStatus = #{app_rcv_area}
		where df_idNumber = #{df_idNumber}
	</insert>
	
	<!-- 반출 이동 승인 (return, final, transMethod 입력(추가)) -->
	<update id="updateFinalExpertApproval" parameterType="Map">
		update expertApproval
		set app_hnd_transMethod = #{app_hnd_transMethod},
		app_rcv_create_at = now(),
		app_isError = #{app_isError},
		app_rcv_status = 'Y'
		where app_num = #{app_num};
		
		update blockInformation
		set df_itemStatus = '이상없음',
		df_moveStatus = '-'
		where df_idNumber = (select df_idNumber from expertApproval where app_num = #{app_num});
		
		update blockMoveList
		set moveList_return_date = now(),
		df_itemStatus = '이상없음'
		where moveList_return_date is null and
		df_idNumber = (select df_idNumber from expertApproval where app_num = #{app_num})
	</update>
	
	<!-- 반출 이동 사인 업로드 -->
	<select id="distinctCheckExpertSign" parameterType="Map">
		select count(*) from expertSignList where expSign_name = #{expSign_name} and app_rcv_area = #{app_rcv_area}
	</select>
	
	<insert id="insertExpertSignUpload" parameterType="Map">
		insert into expertSignList(expSign_name, app_rcv_area) values(#{expSign_name}, #{app_rcv_area})
	</insert>
	
	<update id="updateExpertSign" parameterType="Map">
		update expertApproval
		set expSign_num = (select expSign_num from expertSignList where expSign_name = #{expSign_name} and app_rcv_area = #{app_rcv_area})
		where app_num = #{app_num}
	</update>
	
	<select id="checkFileName" parameterType="String" resultType="int">
		select count(*) from expertSignList where expSign_name = #{expSign_name}
	</select>
	
	<!-- 이동 거절 -->
	<update id="updateRejection" parameterType="Map">
		update Approval
		<if test="searchArea != '본사'">
			set app_rcv_status = 'N'
		</if>
		<if test="searchArea == '본사'">
			set app_head_status = 'N'
		</if>
		where app_num = #{app_num};
	</update>
	
	<update id="finalRejection" parameterType="int">
		update blockInformation
		set df_itemStatus = '이상없음',
		df_moveStatus = '-'
		where df_idNumber = (select df_idNumber from Approval where app_num = #{app_num});
	</update>
	
	<!-- 반출 거절 -->
	<update id="updateExpertRejection" parameterType="Map">
	<if test="app_type == 'rental'"> 
		update expertApproval
		<if test="token == 1">
			set app_head_status = 'N',
		</if>
		<if test="token == 2">
			set app_rcv_status = 'N',
		</if>
		app_isError = #{app_isError}
		where app_num = #{app_num}
	</if>
	
	<if test="app_type == 'return'">
		update expertApproval
		<if test="token == 1">
			set app_head_status = 'N',
		</if>
		<if test="token == 2">
			set app_rcv_status = 'N',
		</if>
		app_isError = #{app_isError}
		where app_num = #{app_num}
	</if>
	</update>
	
	<select id="countExpertRejection" parameterType="int" resultType="int">
		select count(*) from expertApproval where (app_head_status = 'N' or app_rcv_status = 'N') and app_num = #{app_num}
	</select>
	
	<update id="rejectionRollbackData" parameterType="Map">
		<if test="count == 0">
			update blockInformation
			set df_itemStatus = '이상없음',
			df_moveStatus = '-'
			where df_idNumber = (select df_idNumber from expertApproval where app_num = #{app_num})
		</if>
		<if test="count == 1">
			update expertApproval a inner join 
			(select request_reject_num from expertApproval where app_num = #{app_num}) b 
			on a.app_num = b.request_reject_num
			set returnRequest = 'N'
		</if>
	</update>
	
	<!-- 블럭 스펙 추가 -->
	<insert id="insertBlockSpec" parameterType="Map">
		insert into blockSpec_image(df_idNumber, file_name, file_path, login_area)
		values (#{df_idNumber}, #{img.file_name}, #{img.file_path}, #{searchArea})
	</insert>
	
	<!-- 블럭 스펙 보기 -->
	<select id="selectBlockSpecView" parameterType="String">
		select * from blockSpec_Image where df_num = #{df_num}
	</select>
	
	<!-- 블럭 스펙 삭제 -->
	<select id="deleteBlockSpec" parameterType="String">
		delete from blockSpec_Image where df_idNumber = #{df_idNumber}
	</select>
	
	<!-- 블럭 점검 게시판 수 카운트 -->
	<select id="inspectionListCount" parameterType="String">
		select count(*) from blockInspectionBoard
		<if test="searchArea != '본사'">
			where login_area = #{searchArea}
		</if>
	</select>
	
	<!-- 블럭 점검 리스트 -->
	<select id="selectInspectionList" parameterType="String">
		select * from (
			select row_number() over (order by bib_date asc) as row_num, blockInspectionBoard.* from blockInspectionBoard 
			<if test="searchArea != '본사'">
				where login_area = #{searchArea}
			</if>
			order by row_num desc limit #{offset}, #{limit}
		) sub order by row_num desc
	</select>
	
	<!-- 블럭 점검 폼 -->
	<select id="inspectionList" parameterType="String">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, df_idNumber from blockInformation where login_area = #{searchArea}
		) sub order by row_num desc
	</select>

	<!-- 블럭 점검 추가 (정보저장) -->
	<insert id="insertInspectionBoard" parameterType="String">
		insert into blockInspectionBoard (bib_title, bib_date, login_area)
		values (#{bib_title}, now(), #{searchArea})
	</insert>
	
	<select id="selectBib_num" parameterType="String">
		select max(bib_num) from blockInspectionBoard where login_area = #{searchArea}
	</select>
	
	<insert id="insertInspectionList" parameterType="Map">
		insert into blockInspectionList (bil_status, bil_date, df_idNumber, login_area, bib_num) values
		<foreach collection="blockInspectionList" item="item" separator=",">
			(#{item.bil_status}, now(), #{item.df_idNumber}, #{item.login_area}, #{item.bib_num})
		</foreach>
	</insert>
	
	<!-- 블럭 점검 보기 -->
	<select id="selectBlockInspectionView" parameterType="int">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, blockInspectionList.* 
			from blockInspectionList where bib_num = #{bib_num}
		) sub order by row_num desc
	</select>
	
	<select id="selectInspectionTitle" parameterType="int">
		select bib_title from blockInspectionBoard where bib_num = #{bib_num}
	</select>
	
	<!-- 블럭 점검 삭제 -->
	<delete id="deleteInspectionView" parameterType="int">
		delete from blockInspectionBoard where bib_num = #{bib_num};
		
		delete from blockInspectionList where bib_num = #{bib_num}
	</delete>
	
	<!-- 블럭 점검 이력 보기 -->
	<select id="inspectionHistoryCount" parameterType="String">
		select count(*) from blockInspectionList where df_idNumber = #{df_idNumber}
	</select>
	
	<select id="selectInspectionHistory" parameterType="Map">
		select * from (
			select row_number() over (order by df_idNumber asc) as row_num, blockInspectionList.*
			from blockInspectionList where df_idNumber = #{df_idNumber}
			order by row_num desc limit #{offset}, #{limit}
		) sub order by row_num desc
	</select>
	
	<!-- 블럭 제작 요청 게시판 -->
	<select id="createBlockListCount" parameterType="String">
		select count(*) from createBlockBoard
		<if test="searchArea != '본사'">
		 where login_area = #{searchArea}
		</if>
	</select>
	
	<select id="selectCreateBlockList" parameterType="Map">
		select * from (
			select row_number() over (order by createBlockBoard_date asc) as row_num, a.*, b.createBlock_status 
			from createBlockBoard a inner join createBlock b on a.createBlockBoard_num = b.createBlockBoard_num
			<if test="searchArea != '본사'">
				where a.login_area = #{searchArea}
			</if>
			order by row_num desc limit #{offset}, #{limit}
		) sub order by row_num desc
	</select>
	
	<!-- 블럭 제작 (정보 저장) -->
	<insert id="insertCreateBlockBoard" parameterType="Map" useGeneratedKeys="true" keyProperty="createBlockForm.createBlockBoard_num">
		insert into createBlockBoard(createBlockBoard_title, createBlockBoard_date, login_area)
		values(#{createBlockForm.createBlockBoard_title}, now(), #{searchArea});
	</insert>
	<insert id="insertCreateBlockInformation" parameterType="Map" useGeneratedKeys="true" keyProperty="createBlockForm.createBlock_num">
		insert into createBlock(blockSpec, df_usage, blockSpec_material, blockSpec_thick, blockSpec_diameter, blockSpec_weld, login_area, createBlockBoard_num)
		values(#{createBlockForm.blockSpec}, #{createBlockForm.df_usage}, #{createBlockForm.blockSpec_material}, #{createBlockForm.blockSpec_thick}, #{createBlockForm.blockSpec_diameter}, #{createBlockForm.blockSpec_weld}, #{searchArea}, #{createBlockForm.createBlockBoard_num});
	</insert>
	<insert id="insertCreateBlockDrawing" parameterType="Map">
		insert into createBlockDrawing(cbd_drawing, createBlock_num) values
		<foreach collection="imgList" item="img" separator=",">
			(#{img.cbd_drawing}, #{img.createBlock_num})
		</foreach>
	</insert>
	
	<!-- 블럭 제작 상세보기 -->
	<select id="selectCreateBlockView" parameterType="int">
		select * from createBlock where createBlockBoard_num = #{createBlockBoard_num}
	</select>
	
	<!-- 블럭 제작 도면 보기 -->
	<select id="selectDrawingView" parameterType="int">
		select * from createBlockDrawing where createBlock_num = #{createBlock_num}
	</select>
	
	<!-- 블럭 제작 승인 -->
	<update id="updateCreateBlockApproval" parameterType="Map">
		update createBlock
		set createBlock_status = 'Y',
		technical_team_comment = #{technical_team_comment}
		where createBlock_num = #{createBlock_num}
	</update>
	
	<!-- 블럭 제작 거절 -->
	<update id="updateCreateBlockRejection" parameterType="Map">
		update createBlock
		set createBlock_status = 'N',
		technical_team_comment = #{technical_team_comment}
		where createBlock_num = #{createBlock_num}
	</update>
	
	<!-- 2025-11-24 이후 기능 구현 - 검색, 삭제 등 (시간 여건상 바로 DAO 직행, 필요시 Service 경유) -->
	<sql id="searchApproval">
		<where>
	        <choose>
	            <when test="searchType == 'idNumber'">
	                df_idNumber LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
				<when test="searchType == 'app_hnd_area'">
					app_hnd_area LIKE CONCAT('%', #{searchQuery}, '%')
				</when>
				<when test="searchType == 'app_rcv_area'">
					app_rcv_area LIKE CONCAT('%', #{searchQuery}, '%')
				</when>
				<when test="searchType == 'approval_status'">
					<choose>
						<when test="searchQuery == '승인'">
							app_rcv_status = 'Y' and app_head_status = 'Y'
						</when>
						<when test="searchQuery == '거절'">
							app_rcv_status = 'N' or app_head_status = 'N'
						</when>
						<otherwise>
							1=1
						</otherwise>
					</choose>			
				</when>
				<otherwise>
	                1 = 1
	            </otherwise>
	        </choose>
	    </where>
	</sql>
	
	<!-- 승인 대기 리스트 검색기능 -->
	<select id="searchApprovalCount" parameterType="Map" resultType="int">
		select count(*) from Approval
		<include refid="searchApproval" />
		<if test="searchArea != '본사'">
			and login_area = #{searchArea}
		</if>
	</select>
	
	<select id="searchApproval" parameterType="Map">
		select * from (
			select row_number() over (order by app_hnd_create_at asc) as row_num, Approval.* from Approval
		<include refid="searchApproval" />
		<if test="searchArea != '본사'">
			and login_area = #{searchArea}
		</if>
		order by row_num desc limit #{offset}, #{limit}
		) sub order by row_num desc
	</select>
	
	<!-- 반출 승인 대기 리스트 검색기능 -->
	<select id="searchExpertApprovalCount" parameterType="Map" resultType="int">
		select count(*) from expertApproval
		<include refid="searchApproval" />
		<if test="searchArea != '본사'">
			and login_area = #{searchArea}
		</if>
	</select>
	
	<select id="searchExpertApproval" parameterType="Map">
		select * from (
			select row_number() over (order by app_hnd_create_at asc) as row_num, expertApproval.* from expertApproval
		<include refid="searchApproval" />
		<if test="searchArea != '본사'">
			and login_area = #{searchArea}
		</if>
		order by row_num desc limit #{offset}, #{limit}
		) sub order by row_num desc
	</select>
	
	<!-- 점검 기록 검색 -->
	<sql id="searchInspection">
		<where>
	        <choose>
	            <when test="searchType == 'bib_title'">
	                bib_title LIKE CONCAT('%', #{searchQuery}, '%')
	            </when>
				<when test="searchType == 'bil_status'">
					bil_status LIKE CONCAT('%', #{searchQuery}, '%')
				</when>
				<otherwise>
	                1 = 1
	            </otherwise>
	        </choose>
	    </where>
	</sql>
	
	<select id="searchInspectionListCount" parameterType="int">
		select count(distinct a.bib_num) from blockInspectionBoard a inner join blockInspectionList b
		on a.bib_num = b.bib_num
		<include refid="searchInspection" />
		<if test="searchArea != '본사'">
			and a.login_area = #{searchArea}
		</if>
		and bib_date between #{startDate} and #{endDate} 
	</select>
	
	<select id="searchInspectionList" parameterType="Map">
		select * from (
			select row_number() over (order by bib_date asc) as row_num, a.*
			from (
				select distinct a.* from blockInspectionBoard a inner join blockInspectionList b
				on a.bib_num = b.bib_num 
				<include refid="searchInspection" />
				<if test="searchArea != '본사'">
					and a.login_area = #{searchArea}
				</if>	
				and bib_date between #{startDate} and #{endDate}
			) a
		) sub order by row_num desc limit #{offset}, #{limit};
	</select>
	
	<!-- 블럭 제작 요청 검색 -->
	<sql id="searchCreateBlock">
		<where>
			<choose>
				<when test="searchType == 'createBlockBoard_title'">
					createBlockBoard_title like concat('%', #{searchQuery}, '%')
				</when>
				<when test="searchType == 'createBlockBoard_date'">
					createBlockBoard_date like concat('%', #{searchQuery},'%')
				</when>
				<when test="searchType == 'blockSpec_material'">
					blockSpec_material like concat('%', #{searchQuery},'%')
				</when>
				<when test="searchType == 'blockSpec_thick'">
					blockSpec_thick like concat('%', #{searchQuery},'%')
				</when>
				<when test="searchType == 'blockSpec_diameter'">
					blockSpec_diameter like concat('%', #{searchQuery},'%')
				</when>
				<when test="searchType == 'blockSpec_weld'">
					blockSpec_weld like concat('%', #{searchQuery},'%')
				</when>
			</choose>
		</where>
	</sql>
	
	<select id="selectCreateListCount" parameterType="Map" resultType="int">
		select count(*) from createBlockBoard a inner join createBlock b on a.createBlockBoard_num = b.createBlockBoard_num
	</select>
	
	<select id="searchCreateBlockList" parameterType="Map">
		select * from (
			select row_number() over (order by createBlockBoard_date asc) as row_num, a.*, b.blockSpec_material, b.blockSpec_thick, b.blockSpec_diameter, b.blockSpec_weld, b.createBlock_status
			from createBlockBoard a inner join createBlock b on a.createBlockBoard_num = b.createBlockBoard_num
			<include refid="searchCreateBlock"/>
			<if test="searchArea != '본사'">
				and a.login_area = #{searchArea}
			</if>
			order by row_num desc limit #{offset}, #{limit}
		) sub
		order by row_num desc
	</select>
	
	<!-- 삭제 통합 -->
	<delete id="deleteMoveList" parameterType="int">
		delete from blockMoveList where moveList_num = #{primaryKey}
	</delete>
	<delete id="deleteApprovalList" parameterType="int">
		delete from Approval where app_num = #{primaryKey}
	</delete>
	<delete id="deleteExpertApprovalList" parameterType="int">
		delete from expertApproval where app_num = #{primaryKey}
	</delete>
	<delete id="deleteInspectionList" parameterType="int">
		delete from blockInspectionBoard where bib_num = #{primaryKey};
		delete from blockInspectionList where bib_num = #{primaryKey}
	</delete>
	<delete id="deleteCreateBlock" parameterType="int">
		delete from createBlockBoard where createBlockBoard_num = #{primaryKey};
		delete from createBlock where createBlockBoard_num = #{primaryKey}
	</delete>
</mapper>